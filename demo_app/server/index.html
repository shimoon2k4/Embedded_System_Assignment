<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Sensor Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .card-title {
            font-weight: bold;
        }
        .card-text {
            font-size: 2.5rem;
            font-weight: 300;
        }
        .status-dot {
            height: 15px;
            width: 15px;
            border-radius: 50%;
            display: inline-block;
        }
        .connected {
            background-color: #28a745;
        }
        .disconnected {
            background-color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Bảng điều khiển IoT</h2>
            <div>
                <span id="status-dot" class="status-dot disconnected"></span>
                <span id="status-text" class="ms-2">Đang kết nối...</span>
            </div>
        </div>

        <!-- Data Display -->
        <div class="row">
            <div class="col-md-4 mb-4">
                <div class="card text-center">
                    <div class="card-header">
                        <h5 class="card-title">Nhiệt độ</h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text" id="temp-value">--.- &deg;C</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card text-center">
                    <div class="card-header">
                        <h5 class="card-title">Độ ẩm</h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text" id="hum-value">--.- %</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card text-center">
                    <div class="card-header">
                        <h5 class="card-title">Ánh sáng</h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text" id="light-value">----</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="row">
            <div class="col-lg-12 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Biểu đồ Nhiệt độ & Độ ẩm</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="tempHumChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configuration -->
        <div class="row">
            <div class="col-lg-12 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Cấu hình thiết bị</h5>
                    </div>
                    <div class="card-body">
                        <form id="config-form">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="wifi-ssid" class="form-label">Tên WiFi (SSID)</label>
                                    <input type="text" class="form-control" id="wifi-ssid" placeholder="Để trống nếu không muốn đổi">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="wifi-pass" class="form-label">Mật khẩu WiFi</label>
                                    <input type="password" class="form-control" id="wifi-pass" placeholder="Để trống nếu không muốn đổi">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="device-id" class="form-label">ID Thiết bị</label>
                                    <input type="text" class="form-control" id="device-id" placeholder="ví dụ: esp32-device-01">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="send-interval" class="form-label">Chu kỳ gửi dữ liệu (giây)</label>
                                    <input type="number" class="form-control" id="send-interval" placeholder="ví dụ: 30">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Cập nhật cấu hình</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MQTT.js and Chart.js from CDN -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // --- CONFIGURATION ---
        // Use public HiveMQ websocket (non-TLS) for demo. If you prefer TLS use wss:// and port 8884.
        const BROKER_URL = 'ws://broker.hivemq.com:8000/mqtt';

        // The DEVICE_ID will be taken from the device-id input field. If blank, user must enter it
        function getDeviceId() {
            const v = document.getElementById('device-id').value;
            return v ? v.trim() : null;
        }

        function dataTopicFor(id) { return `iot/device/${id}/data`; }
        function configTopicFor(id) { return `iot/device/${id}/config`; }
        const MAX_CHART_POINTS = 20;

        // --- DOM ELEMENTS ---
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const tempValue = document.getElementById('temp-value');
        const humValue = document.getElementById('hum-value');
        const lightValue = document.getElementById('light-value');
        const configForm = document.getElementById('config-form');

        // --- CHART INITIALIZATION ---
        const ctx = document.getElementById('tempHumChart').getContext('2d');
        const tempHumChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Nhiệt độ (°C)',
                        data: [],
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        yAxisID: 'y-temp',
                    },
                    {
                        label: 'Độ ẩm (%)',
                        data: [],
                        borderColor: 'rgba(54, 162, 235, 1)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        yAxisID: 'y-hum',
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        title: { display: true, text: 'Thời gian' }
                    },
                    'y-temp': {
                        type: 'linear',
                        position: 'left',
                        title: { display: true, text: 'Nhiệt độ (°C)' },
                        ticks: { color: 'rgba(255, 99, 132, 1)' }
                    },
                    'y-hum': {
                        type: 'linear',
                        position: 'right',
                        title: { display: true, text: 'Độ ẩm (%)' },
                        grid: { drawOnChartArea: false },
                        ticks: { color: 'rgba(54, 162, 235, 1)' }
                    }
                }
            }
        });

        // --- MQTT CLIENT ---
        let client = null;
        let currentSub = null;

        function connectAndSubscribe(deviceId) {
            if (!deviceId) return;
            if (client) {
                try { client.end(); } catch(e){}
                client = null;
            }
            client = mqtt.connect(BROKER_URL);

            client.on('connect', () => {
                console.log('Connected to MQTT Broker!');
                statusDot.classList.remove('disconnected');
                statusDot.classList.add('connected');
                statusText.textContent = 'Đã kết nối';

                const topic = dataTopicFor(deviceId);
                currentSub = topic;
                client.subscribe(topic, (err) => {
                    if (!err) console.log(`Subscribed to topic: ${topic}`);
                });
            });

            client.on('reconnect', () => {
                console.log('Reconnecting...');
                statusText.textContent = 'Đang kết nối lại...';
            });

            client.on('error', (err) => {
                console.error('Connection error: ', err);
                try { client.end(); } catch(e){}
            });

            client.on('message', (topic, message) => {
                console.log(`Received message from ${topic}: ${message.toString()}`);
                try {
                    const data = JSON.parse(message.toString());
                    const now = new Date();
                    const timeLabel = `${now.getHours()}:${now.getMinutes()}:${now.getSeconds()}`;

                    // Support both Vietnamese keys and english keys
                    const temp = (data.nhiet_do !== undefined) ? data.nhiet_do : data.temperature;
                    const hum = (data.do_am !== undefined) ? data.do_am : data.humidity;
                    const light = (data.anh_sang !== undefined) ? data.anh_sang : data.light;

                    // Update cards
                    if (typeof temp === 'number') tempValue.innerHTML = `${temp.toFixed(1)} &deg;C`;
                    if (typeof hum === 'number') humValue.innerHTML = `${hum.toFixed(1)} %`;
                    if (typeof light !== 'undefined') lightValue.textContent = light;

                    // Update chart
                    if (tempHumChart.data.labels.length > MAX_CHART_POINTS) {
                        tempHumChart.data.labels.shift();
                        tempHumChart.data.datasets.forEach(dataset => dataset.data.shift());
                    }
                    
                    tempHumChart.data.labels.push(timeLabel);
                    tempHumChart.data.datasets[0].data.push(temp);
                    tempHumChart.data.datasets[1].data.push(hum);
                    tempHumChart.update();

                } catch (e) {
                    console.error('Error parsing message JSON:', e);
                }
            });

        // --- FORM HANDLING ---
        configForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const configPayload = {};
            const wifiSSID = document.getElementById('wifi-ssid').value;
            const wifiPass = document.getElementById('wifi-pass').value;
            const deviceID = document.getElementById('device-id').value;
            const sendInterval = document.getElementById('send-interval').value;

            if (wifiSSID && wifiPass) {
                configPayload.wifi_ssid = wifiSSID;
                configPayload.wifi_pass = wifiPass;
            }
            if (sendInterval) {
                configPayload.interval = parseInt(sendInterval, 10) * 1000;
            }

            if (!deviceID) {
                alert('Vui lòng nhập Device ID trước khi gửi cấu hình.');
                return;
            }

            // Publish config to device via MQTT
            const cfgTopic = configTopicFor(deviceID);
            const payloadString = JSON.stringify(configPayload);
            if (client && client.connected()) {
                client.publish(cfgTopic, payloadString, (err) => {
                    if (err) {
                        alert('Gửi cấu hình thất bại!');
                        console.error(err);
                    } else {
                        alert('Đã gửi yêu cầu cập nhật cấu hình đến thiết bị!');
                    }
                });
            } else {
                alert('Chưa kết nối tới MQTT broker. Vui lòng nhấn nút Connect.');
            }
        });

        // Connect button behavior (connects using provided device id)
        const connectBtn = document.createElement('button');
        connectBtn.textContent = 'Connect';
        connectBtn.className = 'btn btn-secondary ms-2';
        connectBtn.type = 'button';
        document.getElementById('device-id').parentNode.appendChild(connectBtn);
        connectBtn.addEventListener('click', () => {
            const id = getDeviceId();
            if (!id) { alert('Nhập Device ID trước khi kết nối.'); return; }
            connectAndSubscribe(id);
        });

    </script>
</body>
</html>
