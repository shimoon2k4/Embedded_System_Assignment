void handle_root() {
  String html = R"rawliteral(
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IoT Sensor Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .card-title { font-weight: bold; }
    .card-text { font-size: 2.5rem; font-weight: 300; }
    .status-dot { height: 15px; width: 15px; border-radius: 50%; display: inline-block; }
    .connected { background-color: #28a745; }
    .disconnected { background-color: #dc3545; }
  </style>
</head>
<body>
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>Bảng điều khiển IoT</h2>
      <div>
        <span id="status-dot" class="status-dot disconnected"></span>
        <span id="status-text" class="ms-2">Đang kết nối...</span>
      </div>
    </div>

    <div class="row">
      <div class="col-md-4 mb-4">
        <div class="card text-center">
          <div class="card-header"><h5 class="card-title">Nhiệt độ</h5></div>
          <div class="card-body"><p class="card-text" id="temp-value">--.- &deg;C</p></div>
        </div>
      </div>
      <div class="col-md-4 mb-4">
        <div class="card text-center">
          <div class="card-header"><h5 class="card-title">Độ ẩm</h5></div>
          <div class="card-body"><p class="card-text" id="hum-value">--.- %</p></div>
        </div>
      </div>
      <div class="col-md-4 mb-4">
        <div class="card text-center">
          <div class="card-header"><h5 class="card-title">Ánh sáng</h5></div>
          <div class="card-body"><p class="card-text" id="light-value">----</p></div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-lg-12 mb-4">
        <div class="card">
          <div class="card-header"><h5 class="card-title">Biểu đồ Nhiệt độ &amp; Độ ẩm</h5></div>
          <div class="card-body"><canvas id="tempHumChart"></canvas></div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-lg-12 mb-4">
        <div class="card">
          <div class="card-header"><h5 class="card-title">Cấu hình (MQTT – tùy chọn)</h5></div>
          <div class="card-body">
            <form id="config-form">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">ID Thiết bị</label>
                  <input type="text" class="form-control" id="device-id" placeholder="Tự điền từ /status" readonly>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="send-interval" class="form-label">Chu kỳ gửi dữ liệu (giây)</label>
                  <input type="number" class="form-control" id="send-interval" placeholder="vd: 30">
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="wifi-ssid" class="form-label">Tên WiFi (SSID)</label>
                  <input type="text" class="form-control" id="wifi-ssid" placeholder="Để trống nếu không đổi">
                </div>
                <div class="col-md-6 mb-3">
                  <label for="wifi-pass" class="form-label">Mật khẩu WiFi</label>
                  <input type="password" class="form-control" id="wifi-pass" placeholder="Để trống nếu không đổi">
                </div>
              </div>
              <button type="submit" class="btn btn-primary">Gửi cấu hình qua MQTT</button>
              <div class="form-text">Broker: wss://test.mosquitto.org:8081/mqtt</div>
            </form>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    const MAX_CHART_POINTS = 20;
    const MQTT_URL = 'wss://test.mosquitto.org:8081/mqtt';

    const statusDot  = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');
    const tempValue  = document.getElementById('temp-value');
    const humValue   = document.getElementById('hum-value');
    const lightValue = document.getElementById('light-value');
    const deviceIdEl = document.getElementById('device-id');
    const cfgForm    = document.getElementById('config-form');

    const ctx = document.getElementById('tempHumChart').getContext('2d');
    const tempHumChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          { label: 'Nhiệt độ (°C)', data: [], borderColor: 'rgba(255, 99, 132, 1)', backgroundColor: 'rgba(255, 99, 132, 0.2)', yAxisID: 'y-temp' },
          { label: 'Độ ẩm (%)',   data: [], borderColor: 'rgba(54, 162, 235, 1)', backgroundColor: 'rgba(54, 162, 235, 0.2)', yAxisID: 'y-hum'  }
        ]
      },
      options: {
        responsive: true,
        scales: {
          x: { title: { display: true, text: 'Thời gian' } },
          'y-temp': { type: 'linear', position: 'left',  title: { display: true, text: 'Nhiệt độ (°C)' } },
          'y-hum':  { type: 'linear', position: 'right', title: { display: true, text: 'Độ ẩm (%)' }, grid: { drawOnChartArea: false } }
        }
      }
    });

    function setStatus(ok, text){
      statusDot.classList.toggle('connected', ok);
      statusDot.classList.toggle('disconnected', !ok);
      statusText.textContent = text;
    }

    function pushChart(temp, hum){
      const t = new Date().toLocaleTimeString();
      if (tempHumChart.data.labels.length > MAX_CHART_POINTS) {
        tempHumChart.data.labels.shift();
        tempHumChart.data.datasets.forEach(d => d.data.shift());
      }
      tempHumChart.data.labels.push(t);
      tempHumChart.data.datasets[0].data.push(temp);
      tempHumChart.data.datasets[1].data.push(hum);
      tempHumChart.update();
    }

    async function pollData(){
      try{
        const r = await fetch('/data', {cache:'no-store'});
        if(!r.ok) throw new Error('HTTP '+r.status);
        const data = await r.json();

        const temp  = (data.nhiet_do !== undefined) ? data.nhiet_do : data.temperature;
        const hum   = (data.do_am   !== undefined) ? data.do_am   : data.humidity;
        const light = (data.anh_sang!== undefined) ? data.anh_sang: data.light;

        if (typeof temp  === 'number') tempValue.innerHTML = `${temp.toFixed(1)} &deg;C`;
        if (typeof hum   === 'number') humValue.innerHTML  = `${hum.toFixed(1)} %`;
        if (typeof light !== 'undefined') lightValue.textContent = light;

        if (typeof temp === 'number' && typeof hum === 'number') pushChart(temp, hum);
        setStatus(true, 'Đã kết nối (HTTP)');
      }catch(e){
        console.error(e);
        setStatus(false, 'HTTP lỗi');
      }
    }

    async function loadStatus(){
      try{
        const r = await fetch('/status', {cache:'no-store'});
        if (!r.ok) return;
        const s = await r.json();
        if (s && s.device_id) deviceIdEl.value = s.device_id;
      }catch(_){}
    }

    // MQTT (optional) — gửi cấu hình
    let mqttClient = null;
    function ensureMqtt(){
      if (mqttClient && mqttClient.connected) return mqttClient;
      mqttClient = mqtt.connect(MQTT_URL);
      mqttClient.on('connect', ()=>console.log('MQTT connected'));
      mqttClient.on('error',   e=>console.error('MQTT error', e));
      return mqttClient;
    }
    function getConfigTopic(){
      const id = deviceIdEl.value.trim();
      return id ? `iot/device/${id}/config` : null;
    }
    cfgForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const topic = getConfigTopic();
      if (!topic) { alert('Chưa có Device ID (đợi /status).'); return; }

      const payload = {};
      const ssid = document.getElementById('wifi-ssid').value.trim();
      const pass = document.getElementById('wifi-pass').value.trim();
      const intervalSec = parseInt(document.getElementById('send-interval').value, 10);

      if (ssid && pass) { payload.wifi_ssid = ssid; payload.wifi_pass = pass; }
      if (Number.isFinite(intervalSec) && intervalSec > 0) payload.interval = intervalSec * 1000;

      const c = ensureMqtt();
      c.publish(topic, JSON.stringify(payload), (err)=>{
        if (err) { alert('Gửi cấu hình thất bại'); console.error(err); }
        else     { alert('Đã gửi cấu hình qua MQTT'); }
      });
    });

    // Khởi động: tự poll /data mỗi 2 giây và đọc /status để điền DEVICE_ID
    window.addEventListener('load', ()=>{
      loadStatus();
      pollData();
      setInterval(pollData, 2000);
    });
  </script>
</body>
</html>
)rawliteral";
  server.send(200, "text/html", html);
}
